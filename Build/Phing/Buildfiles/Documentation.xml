<?xml version="1.0"?>
<project name="Documentation">

	<taskdef name="phpuml" classname="PhpUmlTask" classpath="Build/Phing/Tasks"/>

	<target name="doc-clean-all" description="Remove all rendered documentation (inside packages)">
		<foreach param="path.package" target="doc-clean">
			<fileset refid="paths-packages"/>
		</foreach>
	</target>

	<target name="doc-render-apis" description="Generate API documentation (inside packages)">
		<foreach param="path.package" target="doc-render-api">
			<fileset refid="paths-packages"/>
		</foreach>
	</target>

	<target name="doc-render-manuals" description="Generate HTML manuals (inside packages)">
		<foreach param="path.package" target="doc-render-manual">
			<fileset refid="paths-packages"/>
		</foreach>
	</target>

	<target name="doc-clean">
		<fail unless="path.package" message="You must set the 'path.package' property to a package path."/>

		<delete dir="${path.package}/Documentation/API/" quiet="true"/>
		<delete dir="${path.package}/Documentation/Manual/HTML" quiet="true"/>
	</target>

	<target name="doc-render-api">
		<fail unless="path.package" message="You must set the 'path.package' property to a package path."/>

		<if>
			<available file="${path.package}/Classes" type="dir"/>
			<then>
				<xmlproperty file="${path.package}/Meta/Package.xml" prefix="meta"/>
				<delete dir="${path.package}/Documentation/API/HTML/en" quiet="true"/>
				<mkdir dir="${path.package}/Documentation/API/HTML/en"/>
				<phpuml
					input="${path.package}/Classes"
					output="${path.package}/Documentation/API/HTML/en"
					title="${meta.package.title}"/>
			</then>
		</if>
	</target>

	<target name="doc-render-manual">
		<fail unless="path.package" message="You must set the 'path.package' property to a package path."/>

		<if>
			<available file="${path.package}/Documentation/Manual/DocBook/en"/>
			<then>
				<property name="manual.sourcedir" value="${path.package}/Documentation/Manual/DocBook/en"/>
				<property name="manual.targetdir" value="${path.package}/Documentation/Manual/HTML/en"/>

				<delete dir="${manual.targetdir}" quiet="true"/>
				<mkdir dir="${manual.targetdir}"/>

				<copy file="${project.builddir}/Resources/Manual/Css/TheGuide.css" todir="${manual.targetdir}"/>
				<copy todir="${manual.targetdir}/images/">
					<fileset dir="${project.builddir}/Resources/Manual/Xsl/DocBookXSLNS/images">
						<include name="**"/>
					</fileset>
				</copy>
				<copy todir="${manual.targetdir}">
					<fileset dir="${manual.sourcedir}">
						<include name="**/*.png"/>
						<include name="**/*.jpg"/>
						<include name="**/*.gif"/>
						<include name="**/*.svg"/>
					</fileset>
				</copy>

				<delete dir="${project.builddir}/Temporary/DocBookRendering" quiet="true"/>
				<mkdir dir="${project.builddir}/Temporary/DocBookRendering" />
				<copy todir="${project.builddir}/Temporary/DocBookRendering">
					<filterchain>
						<replacetokens begintoken="{" endtoken="}">
							<token key="DocBookXSLNSPath" value="${project.builddir}Resources/Manual/Xsl/DocBookXSLNS/"/>
							<token key="outputDirectory" value="${manual.targetdir}"/>
						</replacetokens>
					</filterchain>
					<fileset dir="${project.builddir}/Resources/Manual/Xsl">
						<include name="html.xsl"/>
					</fileset>
				</copy>
				<copy todir="${project.builddir}/Temporary/DocBookRendering">
					<filterchain>
						<xincludefilter basedir="${manual.sourcedir}"/>
					</filterchain>
					<fileset dir="${manual.sourcedir}">
						<include name="Index.xml"/>
					</fileset>
				</copy>
				<xslt todir="${manual.targetdir}" style="${project.builddir}/Temporary/DocBookRendering/html.xsl">
					<fileset dir="${project.builddir}/Temporary/DocBookRendering">
						<include name="Index.xml"/>
					</fileset>
				</xslt>
			</then>
		</if>
	</target>

</project>