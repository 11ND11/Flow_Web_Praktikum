<?xml version="1.0"?>
<project name="Documentation">

	<target name="doc-clean-all" description="Remove all rendered documentation (inside packages)">
		<foreach param="path.package" target="doc-clean">
			<fileset refid="paths-packages"/>
		</foreach>
	</target>

	<target name="doc-render" depends="doc-render-manuals, doc-render-apis"
		description="Build all documentation (inside packages)"/>

	<target name="doc-render-apis" description="Generate API documentation (inside packages)">
		<foreach param="path.package" target="doc-render-api">
			<fileset refid="paths-packages"/>
		</foreach>
	</target>

	<target name="doc-render-manuals" description="Generate HTML manuals (inside packages)">
		<foreach param="path.package" target="doc-render-manual">
			<fileset refid="paths-packages"/>
		</foreach>
	</target>

	<target name="doc-clean">
		<fail unless="path.package" message="You must set the 'path.package' property to a package path."/>

		<delete dir="${path.package}/Documentation/API/" quiet="true"/>
		<delete dir="${path.package}/Documentation/Manual/HTML" quiet="true"/>
	</target>

	<target name="doc-render-api">
		<fail unless="path.package" message="You must set the 'path.package' property to a package path."/>

		<if>
			<available file="${path.package}/Classes" type="dir"/>
			<then>
				<delete dir="${path.package}/Documentation/API/HTML/en" quiet="true"/>
				<mkdir dir="${path.package}/Documentation/API/HTML/en"/>

				<xmlproperty file="${path.package}/Meta/Package.xml"/>
				<phpuml
					input="${path.package}/Classes"
					output="${path.package}/Documentation/API/HTML/en"
					title="${package.title}"/>
			</then>
		</if>
	</target>

	<target name="doc-render-manual">
		<fail unless="path.package" message="You must set the 'path.package' property to a package path."/>

		<if>
			<available file="${path.package}/Documentation/Manual/DocBook/en"/>
			<then>
				<property name="manual.sourceDirectory" value="${path.package}/Documentation/Manual/DocBook/en"/>
				<property name="manual.targetDirectory" value="${path.package}/Documentation/Manual/HTML/en"/>

				<delete dir="${manual.targetDirectory}" quiet="true"/>
				<mkdir dir="${manual.targetDirectory}"/>

				<copy file="${project.buildDirectory}/Resources/Manual/Css/TheGuide.css" todir="${manual.targetDirectory}"/>
				<copy todir="${manual.targetDirectory}/images/">
					<fileset dir="${project.buildDirectory}/Resources/Manual/Xsl/DocBookXSLNS/images">
						<include name="**"/>
					</fileset>
				</copy>
				<copy todir="${manual.targetDirectory}">
					<fileset dir="${manual.sourceDirectory}">
						<include name="**/*.png"/>
						<include name="**/*.jpg"/>
						<include name="**/*.gif"/>
						<include name="**/*.svg"/>
					</fileset>
				</copy>

				<delete dir="${project.buildDirectory}/Temporary/DocBookRendering" quiet="true"/>
				<mkdir dir="${project.buildDirectory}/Temporary/DocBookRendering" />
				<copy todir="${project.buildDirectory}/Temporary/DocBookRendering">
					<filterchain>
						<replacetokens begintoken="{" endtoken="}">
							<token key="DocBookXSLNSPath" value="${project.buildDirectory}Resources/Manual/Xsl/DocBookXSLNS/"/>
							<token key="outputDirectory" value="${manual.targetDirectory}"/>
						</replacetokens>
					</filterchain>
					<fileset dir="${project.buildDirectory}/Resources/Manual/Xsl">
						<include name="html.xsl"/>
					</fileset>
				</copy>
				<copy todir="${project.buildDirectory}/Temporary/DocBookRendering">
					<filterchain>
						<xincludefilter basedir="${manual.sourceDirectory}"/>
					</filterchain>
					<fileset dir="${manual.sourceDirectory}">
						<include name="Index.xml"/>
					</fileset>
				</copy>
				<xslt todir="${manual.targetDirectory}" style="${project.buildDirectory}/Temporary/DocBookRendering/html.xsl">
					<fileset dir="${project.buildDirectory}/Temporary/DocBookRendering">
						<include name="Index.xml"/>
					</fileset>
				</xslt>
			</then>
		</if>
	</target>

</project>